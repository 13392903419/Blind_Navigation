@startuml æ—¶åºå›¾ - è§†é¢‘å¤„ç†æµç¨‹
!theme plain
skinparam backgroundColor #FEFEFE

title ç›²äººå¯¼èˆªç³»ç»Ÿ - ä¸‰æ¨¡å‹æ£€æµ‹æ—¶åºå›¾

actor "ç›²äººç”¨æˆ·" as user
participant "Webç•Œé¢" as web
participant "VideoBlueprint" as video_bp
participant "VideoProcessor" as processor
participant "FrameQueue" as frame_q
participant "YOLOModel\n(æ¨¡å‹1)" as yolo
participant "SceneModel\n(æ¨¡å‹2)" as scene
participant "FightModel\n(æ¨¡å‹3)" as fight
participant "ModelFusion" as fusion
participant "DecisionEngine" as decision
participant "QwenService" as qwen
participant "TTSæœåŠ¡" as tts
participant "ResultQueue" as result_q
database "æ£€æµ‹å†å²" as db

' ==================== è§†é¢‘ä¸Šä¼ é˜¶æ®µ ====================
user -> web : 1. ä¸Šä¼ è§†é¢‘æ–‡ä»¶
web -> video_bp : 2. POST /upload_video
activate video_bp

video_bp -> video_bp : 3. éªŒè¯æ–‡ä»¶æ ¼å¼
video_bp -> processor : 4. åˆ›å»ºå¤„ç†ä»»åŠ¡
activate processor

' ==================== åˆå§‹åŒ–é˜¶æ®µ ====================
processor -> frame_q : 5. åˆ›å»ºå¸§é˜Ÿåˆ—
processor -> result_q : 6. åˆ›å»ºç»“æœé˜Ÿåˆ—

processor -> processor : 7. å¯åŠ¨reader_thread()
processor -> processor : 8. å¯åŠ¨inference_thread()
processor -> processor : 9. å¯åŠ¨display_thread()

video_bp --> web : 10. è¿”å›å¤„ç†ID
web --> user : 11. æ˜¾ç¤º"å¤„ç†ä¸­..."

' ==================== å¸§è¯»å–å¾ªç¯ ====================
loop æ¯å¸§å¤„ç†å¾ªç¯
    processor -> processor : 12. è¯»å–è§†é¢‘å¸§
    processor -> frame_q : 13. put(frame)
    note right
        å¼‚æ­¥é˜Ÿåˆ—
        ç¼“å†²30å¸§
    end note
    
    ' ==================== æ¨ç†çº¿ç¨‹å¹¶è¡Œå¤„ç† ====================
    processor -> frame_q : 14. get() è·å–å¸§
    
    par å¹¶è¡Œæ¨ç†
        processor -> yolo : 15a. predict(frame)
        activate yolo
        yolo -> yolo : æ£€æµ‹ç›²é“+ç‰©ä½“
        yolo --> processor : è¿”å›æ£€æµ‹ç»“æœ
        deactivate yolo
        
        processor -> fight : 15b. detect_fight(frame)
        activate fight
        fight -> fight : æ£€æµ‹å†²çªåœºæ™¯
        fight --> processor : è¿”å›fightç»“æœ
        deactivate fight
    end
    
    ' ==================== æ¡ä»¶åˆ¤æ–­é€»è¾‘ ====================
    processor -> fusion : 16. fuse_results([yolo_res, fight_res])
    activate fusion
    
    alt Fightæ£€æµ‹åˆ°å†²çª
        fusion -> decision : 17a. è§¦å‘ç´§æ€¥é¢„è­¦
        activate decision
        decision -> decision : æœ€é«˜ä¼˜å…ˆçº§å¤„ç†
        decision -> qwen : 18a. "ç”Ÿæˆè­¦å‘ŠæŒ‡ä»¤"
        activate qwen
        qwen --> decision : "å±é™©ï¼å‰æ–¹æœ‰å†²çªï¼Œè¯·ç«‹å³åœæ­¢"
        deactivate qwen
        decision -> tts : 19a. æ’­æ”¾ç´§æ€¥è¯­éŸ³
        activate tts
        tts --> user : ğŸ”Š è­¦å‘ŠéŸ³é¢‘
        deactivate tts
        deactivate decision
    end
    
    alt YOLOæ£€æµ‹åˆ°ç›²é“
        fusion -> fusion : 17b. ç›²é“æ¨¡å¼æ¿€æ´»
        fusion -> fusion : 18b. æ ‡è®°æ‰€æœ‰ç‰©ä½“ä¸ºobstacle
        note right
            person â†’ obstacle
            vehicle â†’ obstacle
            sidewalk â†’ obstacle
        end note
        
        fusion -> decision : 19b. ä¼ é€’ç®€åŒ–ç»“æœ
        activate decision
        decision -> qwen : 20b. "ç”Ÿæˆç›²é“å¯¼èˆª"
        activate qwen
        qwen --> decision : "å‰æ–¹3ç±³ç›²é“ï¼Œå·¦ä¾§æœ‰éšœç¢"
        deactivate qwen
        decision -> tts : 21b. æ’­æ”¾å¯¼èˆªè¯­éŸ³
        activate tts
        tts --> user : ğŸ”Š å¯¼èˆªéŸ³é¢‘
        deactivate tts
        deactivate decision
        
    else æœªæ£€æµ‹åˆ°ç›²é“
        fusion -> scene : 17c. å¯ç”¨åœºæ™¯åˆ†ç±»
        activate scene
        scene -> scene : 18c. è¯¦ç»†åˆ†ç±»
        scene --> fusion : è¿”å›åˆ†ç±»ç»“æœ
        deactivate scene
        
        fusion -> decision : 19c. ä¼ é€’åˆ†ç±»æ•°æ®
        activate decision
        decision -> qwen : 20c. "ç”Ÿæˆåœºæ™¯æè¿°"
        activate qwen
        qwen --> decision : "å‰æ–¹æ˜¯äººè¡Œé“ï¼Œå·¦ä¾§æœ‰è¡Œäºº"
        deactivate qwen
        decision -> tts : 21c. æ’­æ”¾åœºæ™¯è¯­éŸ³
        activate tts
        tts --> user : ğŸ”Š åœºæ™¯éŸ³é¢‘
        deactivate tts
        deactivate decision
    end
    
    ' ==================== ç»“æœè¾“å‡º ====================
    fusion -> fusion : 22. åˆå¹¶æ‰€æœ‰æ£€æµ‹æ¡†
    fusion -> result_q : 23. put(fused_result)
    deactivate fusion
    
    processor -> result_q : 24. get() è·å–ç»“æœ
    processor -> processor : 25. åœ¨å¸§ä¸Šç»˜åˆ¶æ ‡æ³¨
    processor -> db : 26. ä¿å­˜æ£€æµ‹è®°å½•
    
    processor -> web : 27. æ¨é€è§†é¢‘æµ
    web -> user : 28. æ˜¾ç¤ºå®æ—¶ç”»é¢
end

' ==================== ç»“æŸé˜¶æ®µ ====================
user -> web : 29. åœæ­¢æ’­æ”¾
web -> video_bp : 30. åœæ­¢å¤„ç†è¯·æ±‚
video_bp -> processor : 31. stop_processing()
processor -> processor : 32. æ¸…ç†èµ„æº
deactivate processor
deactivate video_bp

user <- web : 33. æ˜¾ç¤º"å¤„ç†å®Œæˆ"

' å›¾ä¾‹è¯´æ˜
note over yolo, fight
    **ä¸‰æ¨¡å‹å¹¶è¡Œç­–ç•¥**
    - æ¨¡å‹1å’Œæ¨¡å‹3å§‹ç»ˆå¹¶è¡Œè¿è¡Œ
    - æ¨¡å‹2ä»…åœ¨æœªæ£€æµ‹åˆ°ç›²é“æ—¶å¯ç”¨
    - Fightæ£€æµ‹ä¼˜å…ˆçº§æœ€é«˜ï¼Œç«‹å³ä¸­æ–­
end note

note over fusion, decision
    **èåˆå†³ç­–é€»è¾‘**
    1. æ£€æŸ¥fight â†’ ç´§æ€¥é¢„è­¦
    2. æ£€æŸ¥ç›²é“ â†’ ç®€åŒ–å¤„ç†
    3. æ— ç›²é“ â†’ è¯¦ç»†åœºæ™¯è¯†åˆ«
end note

@enduml
