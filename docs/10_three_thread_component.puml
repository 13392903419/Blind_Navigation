@startuml ä¸‰çº¿ç¨‹å¼‚æ­¥æ¶æ„ç»„ä»¶å›¾
!theme plain
skinparam backgroundColor #FEFEFE

title ç›²äººå¯¼èˆªç³»ç»Ÿ - ä¸‰çº¿ç¨‹å¼‚æ­¥æ¶æ„è®¾è®¡ (ç»„ä»¶è§†å›¾)

' å®šä¹‰æ ·å¼
skinparam component {
    BackgroundColor #E1F5FE
    BorderColor #01579B
    FontColor #000000
}

skinparam storage {
    BackgroundColor #C8E6C9
    BorderColor #2E7D32
}

' ==================== çº¿ç¨‹1: è¯»å¸§çº¿ç¨‹ ====================
package "ReaderThread è¯»å¸§çº¿ç¨‹" #FFE082 {
    component [VideoCapture\nè§†é¢‘å¥æŸ„] as vc
    component [Read Loop\nè¯»å–å¾ªç¯] as reader
}

' ==================== é˜Ÿåˆ—1: å¸§é˜Ÿåˆ— ====================
storage "FrameQueue\nå¸§é˜Ÿåˆ—\nå®¹é‡:30" as frame_q

note right of frame_q
  maxsize: 30å¸§
  æ ¼å¼: 640Ã—480 RGB
  å†…å­˜: ~3-5MB/å¸§
end note

' ==================== çº¿ç¨‹2: æ¨ç†çº¿ç¨‹ (æ ¸å¿ƒ) ====================
package "InferenceThread æ¨ç†çº¿ç¨‹ (æ ¸å¿ƒ)" #FFCCBC {
    
    ' Phase1 å¿«é€Ÿæ¨ç†
    component [Model1\nYOLOç›²é“æ£€æµ‹\n20ms] as model1 #FFF9C4
    component [Model3\nFightå†²çªæ£€æµ‹\n15ms] as model3 #FFF9C4
    component [Phase1ç»“æœå¤„ç†\nç»˜åˆ¶çº¢æ¡†+è“æ¡†] as phase1_out #B3E5FC
    
    ' Phase2 ç¼“æ…¢æ¨ç†
    component [Model2\nåœºæ™¯åˆ†ç±»\n200ms] as model2 #FFF59D
    component [Phase2ç»“æœå¤„ç†\nç»˜åˆ¶é»„æ¡†+æ ‡ç­¾] as phase2_out #B3E5FC
    
    ' å†³ç­–ç»„ä»¶
    component [DecisionEngine\næ¡ä»¶åˆ¤æ–­] as decision #C8E6C9
    component [FightInterrupt\nç´§æ€¥é¢„è­¦] as interrupt #FFCCCC
}

' ==================== é˜Ÿåˆ—2: ç»“æœé˜Ÿåˆ— ====================
storage "ResultQueue\nç»“æœé˜Ÿåˆ—\nå®¹é‡:30" as result_q

note right of result_q
  Partialç»“æœ:
  {model1, model3}
  
  Fullç»“æœ:
  {model1, model2, model3}
end note

' ==================== çº¿ç¨‹3: æ˜¾ç¤ºçº¿ç¨‹ ====================
package "DisplayThread æ˜¾ç¤ºçº¿ç¨‹" #FFE082 {
    component [generate_frames()\nå¸§ç”Ÿæˆå™¨] as gen_frames
    component [Draw Boxes\nç»˜åˆ¶æ ‡æ³¨] as draw
    component [JPEG Encode\nç¼–ç ] as encode
    component [Stream Output\næµåª’ä½“æ¨é€] as stream
}

' ==================== å¤–éƒ¨ç»„ä»¶ ====================
actor "Browser\næµè§ˆå™¨" as browser

' ==================== æ•°æ®æµè¿æ¥ ====================
vc --> reader : è¯»å–è§†é¢‘
reader --> frame_q : put(Frame)

frame_q --> model1 : get(Frame)
frame_q --> model3 : get(Frame)

model1 --> decision : blind_path_result
model1 --> phase1_out : bboxæ•°æ®
model3 --> interrupt : fight_result
model3 --> phase1_out : bboxæ•°æ®

phase1_out --> result_q : put(Frame_PARTIAL)\nç«‹å³æ¨é€ âœ…
note on link
  T50ms
  å¿«é€Ÿåé¦ˆ
end note

model1 -down-> model2 : è§¦å‘åœºæ™¯åˆ†ç±»\n(å¼‚æ­¥)
model2 --> decision : scene_result
model2 --> phase2_out : bboxæ•°æ®

phase2_out --> result_q : put(Frame_FULL)\nè¡¥å¸§ ğŸŸ¨
note on link
  T250ms
  å®Œæ•´ç»“æœ
end note

result_q --> gen_frames : get(Result)
gen_frames --> draw : ç»“æ„åŒ–æ•°æ®
draw --> encode : ç»˜åˆ¶å®Œæˆ
encode --> stream : JPEG bytes
stream --> browser : å®æ—¶è§†é¢‘æµ

' ==================== å…³é”®è¯´æ˜ ====================
note bottom of model1
  âš¡ Phase1 å¿«é€Ÿæ¨ç†
  Model1 + Model3 å¹¶è¡Œ
  æ€»è€—æ—¶: 20ms
  ç«‹å³æ¨é€åˆ°result_q
  ä¸ç­‰å¾…Model2
end note

note bottom of model2
  ğŸ¢ Phase2 ç¼“æ…¢æ¨ç†
  Model2 åœºæ™¯åˆ†ç±»
  è€—æ—¶: 200ms
  å¼‚æ­¥è¡¥å¸§
  ä¸é˜»å¡Phase1
end note

note top of frame_q
  ğŸ”„ å¼‚æ­¥é˜Ÿåˆ—1
  Readerå¿«é€Ÿå¡«æ»¡
  InferenceæŒç»­æ¶ˆè´¹
end note

note top of result_q
  ğŸ”„ å¼‚æ­¥é˜Ÿåˆ—2
  Partialå¿«é€Ÿå…¥é˜Ÿ
  Fullå¼‚æ­¥è¡¥å……
  BrowseræŒç»­æ¶ˆè´¹
end note

note left of decision
  ğŸ¯ æ¡ä»¶åˆ¤æ–­
  if blind_path:
    æ ‡è®°obstacle
  else:
    è¯¦ç»†åˆ†ç±»
end note

note left of interrupt
  ğŸš¨ æœ€é«˜ä¼˜å…ˆçº§
  æ£€æµ‹åˆ°fight
  ç«‹å³é¢„è­¦
  ä¸­æ–­å…¶ä»–è¯­éŸ³
end note

legend right
  |= é¢œè‰² |= è¯´æ˜ |
  | <#FFE082> | çº¿ç¨‹ç»„ä»¶ |
  | <#FFCCBC> | æ¨ç†å¼•æ“ |
  | <#FFF9C4> | å¿«é€Ÿæ¨¡å‹ |
  | <#FFF59D> | ç¼“æ…¢æ¨¡å‹ |
  | <#B3E5FC> | ç»“æœå¤„ç† |
  | <#C8E6C9> | å†³ç­–/é˜Ÿåˆ— |
  | <#FFCCCC> | é¢„è­¦ç»„ä»¶ |
  
  **å…³é”®æ—¶åº:**
  T0-T50: Phase1å®Œæˆ â†’ Partial
  T0-T250: Phase2å®Œæˆ â†’ Full
  
  **è§†è§‰æ•ˆæœ:**
  å…ˆé»‘å± â†’ å¿«é€Ÿæ¡† â†’ è¡¥å……æ ‡ç­¾
endlegend

@enduml
